!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e||self).automergeSessionHandler={})}(this,function(e){function n(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var o=t.call(e,"string");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof n?n:n+""}function t(e){var n=/^([$a-zA-Z][$a-zA-Z0-9]*):\s*(\S.+)\s*$/.exec(e);if(null==n)throw new Error(e);var t=new Error(n[2]);throw t.name=n[1],t}function o(e){return("number"==typeof e||e instanceof Number)&&(e=e.valueOf(),isFinite(e)&&Math.round(e)===e&&e>=0)}function i(e){return"function"==typeof e}function a(e){return null!=e&&"object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype}var s=!1,r=!0;function c(e,n,o){var i=function(i,a){return function(e,n,o,i,a){if(null==n){if(i)return n;t("MissingArgument: no ".concat(m(e)," given"))}else if(o(n))switch(!0){case n instanceof Boolean:case n instanceof Number:case n instanceof String:return n.valueOf();default:return n}else t("InvalidArgument: the given ".concat(m(e)," is no valid ").concat(m(a)))}(i,a,e,n,o)},a=e.name;return null!=a&&/^ValueIs/.test(a)?function(e,n){if(null==e&&t("MissingArgument: no function given"),"function"!=typeof e&&t("InvalidArgument: the given 1st Argument is not a JavaScript function"),null==n&&t("MissingArgument: no desired name given"),"string"==typeof n||n instanceof String||t("InvalidArgument: the given desired name is not a string"),e.name===n)return e;try{if(Object.defineProperty(e,"name",{value:n}),e.name===n)return e}catch(e){}return new Function("originalFunction","return function "+n+" () {return originalFunction.apply(this,Array.prototype.slice.apply(arguments))}")(e)}(i,a.replace(/^ValueIs/,n?"allow":"expect")):i}var l,u,d,h,f,p,S=/*#__PURE__*/c(o,r,"ordinal number"),g=/*#__PURE__*/c(i,s,"JavaScript function"),_=/*#__PURE__*/c(a,r,'"plain" JavaScript object'),v=/*#__PURE__*/c(a,s,'"plain" JavaScript object');function m(e){return e.replace(/\\x[0-9a-zA-Z]{2}|\\u[0-9a-zA-Z]{4}|\\[0bfnrtv'"\\\/]?/g,function(e){return"\\"===e?"\\\\":e}).replace(/[\x00-\x1f\x7f-\x9f]/g,function(e){switch(e){case"\0":return"\\0";case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"\t":return"\\t";case"\v":return"\\v";default:var n=e.charCodeAt(0).toString(16);return"\\x"+"00".slice(n.length)+n}})}var w=/*#__PURE__*/function(){function e(){this._SessionState="unprepared",this._CancellationReason=void 0,this._StateChangeHandler=void 0,this._UpdateHandler=void 0,this._BroadcastHandler=void 0,this._SessionRepo=void 0,this._SessionURL=void 0,this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._TimerId=void 0}var t,o,i=e.prototype;return i.onStateChange=function(e){g("state change handler",e),this._StateChangeHandler=e},i.onUpdate=function(e){g("document update handler",e),this._UpdateHandler=e},i.update=function(e){if(g("document update callback",e),"open"!==this._SessionState)throw new Error('InvalidState: session is not open, "'+this._SessionState+'"');this._SessionDocHandle.change(e)},i.onBroadcast=function(e){g("broadcast handler",e),this._BroadcastHandler=e},i.broadcast=function(e){if(v("broadcast message",e),"open"!==this._SessionState)throw new Error('InvalidState: session is not open, "'+this._SessionState+'"');this._SessionDocHandle.broadcast(e)},i.prepare=function(e){if(_("repository settings",e),null==l){if(null==window.automerge)throw new Error('InvalidState: "Automerge" has not yet been loaded');var n=window.automerge;l=n.next,u=n.isValidAutomergeUrl,d=n.Repo,h=n.IndexedDBStorageAdapter,f=n.BrowserWebSocketClientAdapter,p=n.BroadcastChannelNetworkAdapter}if("unprepared"!==this._SessionState)throw new Error("InvalidState: session was already prepared before");null==e&&(e={network:[new p,new f("wss://sync.automerge.org")],storage:new h}),this._SessionRepo=new d(e),this._changeSessionStateTo("prepared")},i.create=function(){this.createAndLoad()},i.createAndLoad=function(e){if(null!=e&&!(e instanceof Uint8Array))throw new Error('InvalidArgument: the given "Schema" is not a byte array');if("prepared"!==this._SessionState)throw new Error('InvalidState: session is not in state "prepared"');if(this._SessionDocHandle=this._SessionRepo.create(),null!=e)try{this._SessionDocHandle.change(function(n){return l.merge(n,l.load(e))})}catch(e){this.cancelDueTo("schema load error")}this._SessionDoc=this._SessionDocHandle.docSync(),this._SessionURL=this._SessionDocHandle.url,this._changeSessionStateTo("open")},i.open=function(e,n){try{var t=this;if(!u(e))throw new Error("InvalidArgument: invalid Automerge URL given");if(S("opening timeout [s]",n),"prepared"!==t._SessionState)throw new Error('InvalidState: session is not in state "prepared"');return t._SessionURL=e,t._changeSessionStateTo("opening"),t._SessionDocHandle=t._SessionRepo.find(e),null!=n&&n>0&&(t._TimerId=setTimeout(function(){"ready"!==t._SessionDocHandle.state&&t.cancelDueTo("opening timeout")},1e3*n)),t._SessionDocHandle.whenReady(["deleted","unavailable","ready"]).then(function(){switch(null!=t._TimerId&&clearTimeout(t._TimerId),!0){case t._SessionDocHandle.isDeleted():return void t.cancelDueTo("session deleted");case t._SessionDocHandle.isUnavailable():return void t.cancelDueTo("session unavailable");default:t._SessionDoc=t._SessionDocHandle.docSync(),t._changeSessionStateTo("open")}t._SessionDocHandle.on("change",function(e){"open"===t._SessionState&&null!=t._UpdateHandler&&t._UpdateHandler(e,t)}),t._SessionDocHandle.on("ephemeral-message",function(e){"open"===t._SessionState&&null!=t._BroadcastHandler&&t._BroadcastHandler(e,t)})}),Promise.resolve(t._SessionDocHandle.whenReady())}catch(e){return Promise.reject(e)}},i.close=function(){switch(this._SessionState){case"open":break;case"closed":case"cancelled":return;default:throw new Error('InvalidState: session is not in state "open"')}null!=this._TimerId&&clearTimeout(this._TimerId),this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._changeSessionStateTo("closed")},i.cancel=function(){this.cancelDueTo("session cancelled")},i.cancelDueTo=function(e){switch(void 0===e&&(e="session cancelled"),this._SessionState){case"unprepared":case"prepared":case"opening":case"open":break;case"closed":throw new Error("InvalidState: session has already been closed");case"cancelled":throw new Error("InvalidState: session has already been cancelled")}null!=this._TimerId&&clearTimeout(this._TimerId),this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._CancellationReason=e,this._changeSessionStateTo("cancelled")},i._changeSessionStateTo=function(e){this._SessionState=e,null!=this._StateChangeHandler&&this._StateChangeHandler(e,this)},t=e,(o=[{key:"State",get:function(){return this._SessionState},set:function(e){throw new Error("ReadOnly: a session state can not be explicitly set")}},{key:"CancellationReason",get:function(){return this._CancellationReason},set:function(e){throw new Error("ReadOnly: a cancellation reason can not be explicitly set")}},{key:"URL",get:function(){return this._SessionURL},set:function(e){throw new Error("ReadOnly: a session URL can not be explicitly set")}},{key:"isOpen",get:function(){return"open"===this._SessionState},set:function(e){throw new Error('ReadOnly: "isOpen" can not be explicitly set')}},{key:"Doc",get:function(){return this._SessionDoc},set:function(e){throw new Error("ReadOnly: a session document can not be explicitly set")}},{key:"DocHandle",get:function(){return this._SessionDocHandle},set:function(e){throw new Error("ReadOnly: a session document handle can not be explicitly set")}}])&&function(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,n(i.key),i)}}(t.prototype,o),Object.defineProperty(t,"prototype",{writable:!1}),t}();e.ASH_SessionStates=["unprepared","prepared","opening","open","closed","cancelled"],e.AutomergeSession=w});
//# sourceMappingURL=automerge-session-handler.umd.js.map
