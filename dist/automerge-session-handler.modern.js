function e(e){var n=/^([$a-zA-Z][$a-zA-Z0-9]*):\s*(\S.+)\s*$/.exec(e);if(null==n)throw new Error(e);var t=new Error(n[2]);throw t.name=n[1],t}function n(e){return("number"==typeof e||e instanceof Number)&&(e=e.valueOf(),isFinite(e)&&Math.round(e)===e&&e>=0)}function t(e){return"function"==typeof e}function s(e){return null!=e&&"object"==typeof e&&Object.getPrototypeOf(e)===Object.prototype}var a=!1,i=!0;function o(n,t,s){var a=function(a,i){return function(n,t,s,a,i){if(null==t){if(a)return t;e("MissingArgument: no ".concat(h(n)," given"))}else if(s(t))switch(!0){case t instanceof Boolean:case t instanceof Number:case t instanceof String:return t.valueOf();default:return t}else e("InvalidArgument: the given ".concat(h(n)," is no valid ").concat(h(i)))}(a,i,n,t,s)},i=n.name;return null!=i&&/^ValueIs/.test(i)?function(n,t){if(null==n&&e("MissingArgument: no function given"),"function"!=typeof n&&e("InvalidArgument: the given 1st Argument is not a JavaScript function"),null==t&&e("MissingArgument: no desired name given"),"string"==typeof t||t instanceof String||e("InvalidArgument: the given desired name is not a string"),n.name===t)return n;try{if(Object.defineProperty(n,"name",{value:t}),n.name===t)return n}catch(e){}return new Function("originalFunction","return function "+t+" () {return originalFunction.apply(this,Array.prototype.slice.apply(arguments))}")(n)}(a,i.replace(/^ValueIs/,t?"allow":"expect")):a}var r=/*#__PURE__*/o(n,i,"ordinal number"),c=/*#__PURE__*/o(t,a,"JavaScript function"),l=/*#__PURE__*/o(s,i,'"plain" JavaScript object'),d=/*#__PURE__*/o(s,a,'"plain" JavaScript object');function h(e){return e.replace(/\\x[0-9a-zA-Z]{2}|\\u[0-9a-zA-Z]{4}|\\[0bfnrtv'"\\\/]?/g,function(e){return"\\"===e?"\\\\":e}).replace(/[\x00-\x1f\x7f-\x9f]/g,function(e){switch(e){case"\0":return"\\0";case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"\t":return"\\t";case"\v":return"\\v";default:var n=e.charCodeAt(0).toString(16);return"\\x"+"00".slice(n.length)+n}})}let u,S,p,_,g,f;const w=["unprepared","prepared","opening","open","closed","cancelled"];class v{constructor(){this._SessionState="unprepared",this._CancellationReason=void 0,this._StateChangeHandler=void 0,this._UpdateHandler=void 0,this._BroadcastHandler=void 0,this._SessionRepo=void 0,this._SessionURL=void 0,this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._TimerId=void 0}get State(){return this._SessionState}set State(e){throw new Error("ReadOnly: a session state can not be explicitly set")}get CancellationReason(){return this._CancellationReason}set CancellationReason(e){throw new Error("ReadOnly: a cancellation reason can not be explicitly set")}get URL(){return this._SessionURL}set URL(e){throw new Error("ReadOnly: a session URL can not be explicitly set")}get isOpen(){return"open"===this._SessionState}set isOpen(e){throw new Error('ReadOnly: "isOpen" can not be explicitly set')}get Doc(){return this._SessionDoc}set Doc(e){throw new Error("ReadOnly: a session document can not be explicitly set")}get DocHandle(){return this._SessionDocHandle}set DocHandle(e){throw new Error("ReadOnly: a session document handle can not be explicitly set")}onStateChange(e){c("state change handler",e),this._StateChangeHandler=e}onUpdate(e){c("document update handler",e),this._UpdateHandler=e}update(e){if(c("document update callback",e),"open"!==this._SessionState)throw new Error('InvalidState: session is not open, "'+this._SessionState+'"');this._SessionDocHandle.change(e)}onBroadcast(e){c("broadcast handler",e),this._BroadcastHandler=e}broadcast(e){if(d("broadcast message",e),"open"!==this._SessionState)throw new Error('InvalidState: session is not open, "'+this._SessionState+'"');this._SessionDocHandle.broadcast(e)}prepare(e){if(l("repository settings",e),null==u){if(null==window.automerge)throw new Error('InvalidState: "Automerge" has not yet been loaded');({next:u,isValidAutomergeUrl:S,Repo:p,IndexedDBStorageAdapter:_,BrowserWebSocketClientAdapter:g,BroadcastChannelNetworkAdapter:f}=window.automerge)}if("unprepared"!==this._SessionState)throw new Error("InvalidState: session was already prepared before");null==e&&(e={network:[new f,new g("wss://sync.automerge.org")],storage:new _}),this._SessionRepo=new p(e),this._changeSessionStateTo("prepared")}create(){this.createAndLoad()}createAndLoad(e){if(null!=e&&!(e instanceof Uint8Array))throw new Error('InvalidArgument: the given "Schema" is not a byte array');if("prepared"!==this._SessionState)throw new Error('InvalidState: session is not in state "prepared"');if(this._SessionDocHandle=this._SessionRepo.create(),null!=e)try{this._SessionDocHandle.change(n=>u.merge(n,u.load(e)))}catch(e){this.cancelDueTo("schema load error")}this._SessionDoc=this._SessionDocHandle.docSync(),this._SessionURL=this._SessionDocHandle.url,this._changeSessionStateTo("open")}async open(e,n){if(!S(e))throw new Error("InvalidArgument: invalid Automerge URL given");if(r("opening timeout [s]",n),"prepared"!==this._SessionState)throw new Error('InvalidState: session is not in state "prepared"');return this._SessionURL=e,this._changeSessionStateTo("opening"),this._SessionDocHandle=this._SessionRepo.find(e),null!=n&&n>0&&(this._TimerId=setTimeout(()=>{"ready"!==this._SessionDocHandle.state&&this.cancelDueTo("opening timeout")},1e3*n)),this._SessionDocHandle.whenReady(["deleted","unavailable","ready"]).then(()=>{switch(null!=this._TimerId&&clearTimeout(this._TimerId),!0){case this._SessionDocHandle.isDeleted():return void this.cancelDueTo("session deleted");case this._SessionDocHandle.isUnavailable():return void this.cancelDueTo("session unavailable");default:this._SessionDoc=this._SessionDocHandle.docSync(),this._changeSessionStateTo("open")}this._SessionDocHandle.on("change",e=>{"open"===this._SessionState&&null!=this._UpdateHandler&&this._UpdateHandler(e,this)}),this._SessionDocHandle.on("ephemeral-message",e=>{"open"===this._SessionState&&null!=this._BroadcastHandler&&this._BroadcastHandler(e,this)})}),this._SessionDocHandle.whenReady()}close(){switch(this._SessionState){case"open":break;case"closed":case"cancelled":return;default:throw new Error('InvalidState: session is not in state "open"')}null!=this._TimerId&&clearTimeout(this._TimerId),this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._changeSessionStateTo("closed")}cancel(){this.cancelDueTo("session cancelled")}cancelDueTo(e="session cancelled"){switch(this._SessionState){case"unprepared":case"prepared":case"opening":case"open":break;case"closed":throw new Error("InvalidState: session has already been closed");case"cancelled":throw new Error("InvalidState: session has already been cancelled")}null!=this._TimerId&&clearTimeout(this._TimerId),this._SessionDoc=void 0,this._SessionDocHandle=void 0,this._CancellationReason=e,this._changeSessionStateTo("cancelled")}_changeSessionStateTo(e){this._SessionState=e,null!=this._StateChangeHandler&&this._StateChangeHandler(e,this)}}export{w as ASH_SessionStates,v as AutomergeSession};
//# sourceMappingURL=automerge-session-handler.modern.js.map
